name: KnoxDrive CI/CD

on:
  push:
    branches: [ main ]

jobs:
  deploy-infrastructure:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    outputs:
      ec2_public_ip: ${{ steps.deploy-stack.outputs.EC2PublicIP }}
      s3_bucket: ${{ steps.deploy-stack.outputs.S3BucketName }}
      cloudfront_domain: ${{ steps.deploy-stack.outputs.CloudFrontDomainName }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy CloudFormation Stack
        id: deploy-stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: knoxdrive-stack
          template: cloudformation.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: "KeyName=${{ secrets.AWS_KEY_PAIR_NAME }}"

  deploy-app:
    name: Deploy Application to EC2
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.deploy-infrastructure.outputs.ec2_public_ip }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          scp -r ./* ec2-user@${{ needs.deploy-infrastructure.outputs.ec2_public_ip }}:/home/ec2-user/app/
          ssh ec2-user@${{ needs.deploy-infrastructure.outputs.ec2_public_ip }} << EOF
            cd /home/ec2-user/app
            
            # Create .env file with infrastructure outputs
            # Note: AWS_ACCESS_KEY_ID and SECRET are NOT needed because of IAM Role
            echo "S3_BUCKET=${{ needs.deploy-infrastructure.outputs.s3_bucket }}" > .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            echo "CLOUDFRONT_DOMAIN=${{ needs.deploy-infrastructure.outputs.cloudfront_domain }}" >> .env
            
            pip3 install -r requirements.txt
            # Create a simple systemd service for the app
            sudo bash -c 'cat > /etc/systemd/system/knoxdrive.service << EOL
            [Unit]
            Description=Gunicorn instance to serve KnoxDrive
            After=network.target

            [Service]
            User=ec2-user
            Group=ec2-user
            WorkingDirectory=/home/ec2-user/app
            Environment="PATH=/home/ec2-user/.local/bin:/usr/bin"
            ExecStart=/usr/local/bin/gunicorn --workers 3 --bind 0.0.0.0:80 app:app

            [Install]
            WantedBy=multi-user.target
            EOL'
            sudo systemctl daemon-reload
            sudo systemctl restart knoxdrive
            sudo systemctl enable knoxdrive
          EOF
