name: KnoxDrive Code Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Copy code to EC2
          scp -r ./* ec2-user@${{ secrets.EC2_PUBLIC_IP }}:/home/ec2-user/app/
          
          # Run setup commands on EC2
          ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} << EOF
            cd /home/ec2-user/app
            
            # Create/Update .env file
            echo "S3_BUCKET=${{ secrets.S3_BUCKET_NAME }}" > .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            # Optional: echo "CLOUDFRONT_DOMAIN=${{ secrets.CLOUDFRONT_DOMAIN }}" >> .env
            
            # Install dependencies
            pip3 install -r requirements.txt
            
            # Create/Update systemd service
            sudo bash -c 'cat > /etc/systemd/system/knoxdrive.service << EOL
            [Unit]
            Description=Gunicorn instance to serve KnoxDrive
            After=network.target

            [Service]
            User=ec2-user
            Group=ec2-user
            WorkingDirectory=/home/ec2-user/app
            Environment="PATH=/home/ec2-user/.local/bin:/usr/bin"
            ExecStart=/usr/local/bin/gunicorn --workers 3 --bind 0.0.0.0:80 app:app

            [Install]
            WantedBy=multi-user.target
            EOL'
            
            sudo systemctl daemon-reload
            sudo systemctl restart knoxdrive
            sudo systemctl enable knoxdrive
          EOF
